import { currentOrganizationId } from "@repo/backend/auth/utils";
import { database, tables } from "@repo/backend/database";
import {
  ResizableHandle,
  ResizablePanel,
  ResizablePanelGroup,
} from "@repo/design-system/components/ui/resizable";
import {
  dehydrate,
  HydrationBoundary,
  QueryClient,
} from "@tanstack/react-query";
import { eq, sql } from "drizzle-orm";
import type { ReactNode } from "react";
import type { FeedbackUserCursor } from "@/actions/feedback-user/list";
import { getFeedbackUsers } from "@/actions/feedback-user/list";
import { FeedbackUsersList } from "./components/feedback-user-list";

type UsersDataLayoutProperties = {
  readonly children: ReactNode;
};

const UsersDataLayout = async ({ children }: UsersDataLayoutProperties) => {
  const queryClient = new QueryClient();
  const organizationId = await currentOrganizationId();

  if (!organizationId) {
    return <div />;
  }
  const [countResult] = await Promise.all([
    database
      .select({ count: sql<number>`count(*)` })
      .from(tables.feedbackUser)
      .where(eq(tables.feedbackUser.organizationId, organizationId)),
    queryClient.prefetchInfiniteQuery({
      queryKey: ["feedbackUsers"],
      queryFn: async ({ pageParam }) => {
        const response = await getFeedbackUsers(pageParam);

        if ("error" in response) {
          throw response.error;
        }

        return response;
      },
      initialPageParam: null as FeedbackUserCursor | null,
      getNextPageParam: (lastPage) => lastPage.nextCursor ?? undefined,
      pages: 1,
    }),
  ]);

  const count = countResult?.[0]?.count ?? 0;

  if (count === 0) {
    return <div />;
  }

  return (
    <ResizablePanelGroup direction="horizontal" style={{ overflow: "unset" }}>
      <ResizablePanel
        className="sticky top-0 h-screen"
        defaultSize={30}
        maxSize={35}
        minSize={25}
        style={{ overflow: "auto" }}
      >
        <HydrationBoundary state={dehydrate(queryClient)}>
          <FeedbackUsersList />
        </HydrationBoundary>
      </ResizablePanel>
      <ResizableHandle />
      <ResizablePanel defaultSize={70} style={{ overflow: "unset" }}>
        {children}
      </ResizablePanel>
    </ResizablePanelGroup>
  );
};

export default UsersDataLayout;
